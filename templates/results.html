<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Download Your File</title>
<!-- This page is now self-contained, no Tailwind needed -->
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f4; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; text-align: center; }
.container { background-color: #ffffff; padding: 2.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); max-width: 480px; width: 90%; }
.icon-wrapper { width: 5rem; height: 5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; margin-left: auto; margin-right: auto; transition: background-color 0.3s ease; }
.icon-svg { width: 3rem; height: 3rem; transition: color 0.3s ease; }

    /* Default: Spinner */
    .icon-wrapper { background-color: #dbeafe; /* blue-100 */ }
    .icon-svg { color: #2563eb; /* blue-600 */ }
    .icon-svg.spinning { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Success: Green Check */
    .icon-wrapper.success { background-color: #dcfce7; /* green-100 */ }
    .icon-svg.success { color: #16a34a; /* green-600 */ }
    
    /* Error: Red X */
    .icon-wrapper.error { background-color: #fee2e2; /* red-100 */ }
    .icon-svg.error { color: #dc2626; /* red-600 */ }
    
    h1 { font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-top: 1.5rem; }
    p { color: #4b5563; font-size: 1.125rem; margin-top: 0.75rem; }
    .text-small { font-size: 0.875rem; color: #6b7280; margin-top: 0.75rem; }
    .text-error { color: #dc2626; }
    
    .download-button { 
        display: none; /* Hide by default */ 
        background-color: #2563eb; color: #ffffff; font-weight: 700; font-size: 1.125rem; 
        padding: 0.75rem 2.5rem; margin-top: 2rem; border-radius: 0.5rem; 
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); text-decoration: none; 
        transition: background-color 0.2s ease-in-out; 
    }
    .download-button:hover { background-color: #1d4ed8; }
    
    .back-link { display: block; margin-top: 1.5rem; color: #2563eb; text-decoration: none; transition: color 0.2s ease-in-out; }
    .back-link:hover { color: #1d4ed8; }
</style>


</head>
<body>
<div class="container">
<!-- Icon: Starts as spinner, changes to check or X -->
<div class="icon-wrapper" id="icon-wrapper">
<!-- Spinner Icon -->
<svg class="icon-svg spinning" id="icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<!-- This is the spinner path -->
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2.082a10.003 10.003 0 01-3.675 6.18m-12.022-7.51a10.003 10.003 0 015.83-6.18m3.675 0a10.003 10.003 0 016.18 5.83M4 12h.582m15.356 0a10.003 10.003 0 01-6.18 3.675m-5.83 0a10.003 10.003 0 01-6.18-3.675M4 12v5h.582"></path>
</svg>
</div>
<!-- Main Content -->
<h1 id="message-title">Your job is processing...</h1>
<p id="message-body">
Your files are being analyzed by the AI. This may take a few minutes.
</p>
<p class="text-small" id="message-detail">
Please keep this page open.
</p>
<!-- Download Button (hidden) -->
<div>
<a id="download-link" href="#" download="AI_Resumes_Extract.xlsx" class="download-button">
Download File
</a>
</div>
<!-- Go Back Link -->
<div>
<a href="/" class="back-link" id="back-link">
&larr; Convert More Files
</a>
</div>
</div>

<script>
    // Icons to swap
    const iconSpinner = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2.082a10.003 10.003 0 01-3.675 6.18m-12.022-7.51a10.003 10.003 0 015.83-6.18m3.675 0a10.003 10.003 0 016.18 5.83M4 12h.582m15.356 0a10.003 10.003 0 01-6.18 3.675m-5.83 0a10.003 10.003 0 01-6.18-3.675M4 12v5h.582"></path>';
    const iconSuccess = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
    const iconError = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';

    // Get all the elements we need to update
    const iconWrapper = document.getElementById('icon-wrapper');
    const iconSvg = document.getElementById('icon-svg');
    const title = document.getElementById('message-title');
    const body = document.getElementById('message-body');
    const detail = document.getElementById('message-detail');
    const downloadLink = document.getElementById('download-link');
    const backLink = document.getElementById('back-link');

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id');
        
        if (!jobId) {
            showError("No job ID found. Please go back and try uploading again.");
            return;
        }

        // Start polling the server for the job status
        pollStatus(jobId);
    };

    function pollStatus(jobId) {
        // Check the status right away
        check();

        // And then check every 5 seconds
        const interval = setInterval(check, 5000);

        async function check() {
            try {
                const response = await fetch(`/status/${jobId}`);
                const data = await response.json();

                if (data.status === 'complete') {
                    clearInterval(interval);
                    showSuccess(data.download_url);
                } else if (data.status === 'failed') {
                    clearInterval(interval);
                    showError(data.error || "The job failed to process. This might be due to a corrupted file. Please try again.");
                }
                // If status is 'pending', do nothing and let the interval check again
                
            } catch (err) {
                console.error("Polling error:", err);
                // Don't stop polling, just log the error
            }
        }
    }
    
    function showSuccess(downloadUrl) {
        iconWrapper.className = 'icon-wrapper success';
        iconSvg.innerHTML = iconSuccess;
        
        title.textContent = 'Conversion Successful!';
        body.textContent = 'Your file has been processed and is ready to download.';
        detail.textContent = 'Click the button below to download your file.';
        
        downloadLink.href = downloadUrl;
        downloadLink.style.display = 'inline-block'; // Show the button
        
        // Auto-click the download link
        downloadLink.click();
    }
    
    function showError(errorMessage) {
        iconWrapper.className = 'icon-wrapper error';
        iconSvg.innerHTML = iconError;
        
        title.textContent = 'Processing Failed';
        body.textContent = 'Something went wrong while processing your files.';
        detail.textContent = `Error: ${errorMessage}`;
        detail.classList.add('text-error');
    }

</script>


</body>
</html>